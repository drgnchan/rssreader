name: Android CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # 当推送 v 开头的 tag 时触发 (如 v1.0.0)
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # 普通推送和 PR：构建 debug 版本
      - name: Build APK (debug, split per ABI)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: flutter build apk --debug --split-per-abi

      - name: Upload APK artifacts (debug)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: readyou-apk-debug
          path: build/app/outputs/flutter-apk/*.apk

  # Release job：当推送 tag 时触发
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: []  # 不依赖 build job，独立运行
    permissions:
      contents: write  # 需要写权限来创建 release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # 构建 release 版本 APK
      - name: Build APK (release, split per ABI)
        run: flutter build apk --release --split-per-abi

      # 也构建一个通用 APK (fat APK)
      - name: Build APK (release, universal)
        run: flutter build apk --release

      # 获取版本号（从 tag 中提取）
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # 重命名 APK 文件，添加版本号
      - name: Rename APK files
        run: |
          cd build/app/outputs/flutter-apk
          mv app-arm64-v8a-release.apk readyou-${{ steps.get_version.outputs.VERSION }}-arm64-v8a.apk
          mv app-armeabi-v7a-release.apk readyou-${{ steps.get_version.outputs.VERSION }}-armeabi-v7a.apk
          mv app-x86_64-release.apk readyou-${{ steps.get_version.outputs.VERSION }}-x86_64.apk
          mv app-release.apk readyou-${{ steps.get_version.outputs.VERSION }}-universal.apk

      # 创建 GitHub Release 并上传 APK
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ReadYou ${{ steps.get_version.outputs.VERSION }}

            ### 下载
            - `arm64-v8a`: 适用于大多数现代 Android 设备 (64位)
            - `armeabi-v7a`: 适用于较旧的 Android 设备 (32位)
            - `x86_64`: 适用于 x86 模拟器或特定设备
            - `universal`: 通用版本，包含所有架构（文件较大）

            ### 安装说明
            1. 下载适合您设备的 APK 文件
            2. 在设备上允许安装未知来源应用
            3. 安装 APK 文件
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            build/app/outputs/flutter-apk/readyou-${{ steps.get_version.outputs.VERSION }}-arm64-v8a.apk
            build/app/outputs/flutter-apk/readyou-${{ steps.get_version.outputs.VERSION }}-armeabi-v7a.apk
            build/app/outputs/flutter-apk/readyou-${{ steps.get_version.outputs.VERSION }}-x86_64.apk
            build/app/outputs/flutter-apk/readyou-${{ steps.get_version.outputs.VERSION }}-universal.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
